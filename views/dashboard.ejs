<%- include('partials/header') %>
<div id="dashboardArea">
    <div class="flex justify-end mb-4 space-x-2">
        <button id="exportExcelBtn"
    class="flex items-center gap-2 px-5 py-2.5 bg-green-600 text-white font-semibold rounded-xl shadow-md hover:bg-green-700 hover:shadow-lg transition duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-green-400 focus:ring-offset-2">
    <i class="fas fa-file-excel text-white text-lg"></i>
    Ekspor ke Excel
</button>
    </div>

    <!-- Statistics Cards -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <!-- ...statistik cards seperti sebelumnya... -->
        <div class="stat-card p-6 rounded-2xl shadow-lg metric-card border-l-4 border-indigo-500">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-semibold text-gray-600 uppercase tracking-wide">Total Personel</p>
                    <p class="text-3xl font-bold text-gray-800 mt-2"><%= stats.personel %></p>
                </div>
                <div class="w-12 h-12 bg-indigo-100 rounded-full flex items-center justify-center">
                    <i class="fas fa-users text-indigo-600 text-xl"></i>
                </div>
            </div>
        </div>
        <div class="stat-card p-6 rounded-2xl shadow-lg metric-card border-l-4 border-emerald-500">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-semibold text-gray-600 uppercase tracking-wide">Total Posisi Kerja</p>
                    <p class="text-3xl font-bold text-gray-800 mt-2"><%= stats.posisi %></p>
                </div>
                <div class="w-12 h-12 bg-emerald-100 rounded-full flex items-center justify-center">
                    <i class="fas fa-briefcase text-emerald-600 text-xl"></i>
                </div>
            </div>
        </div>
        <div class="stat-card p-6 rounded-2xl shadow-lg metric-card border-l-4 border-purple-500">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-semibold text-gray-600 uppercase tracking-wide">Total Jenis Shift</p>
                    <p class="text-3xl font-bold text-gray-800 mt-2"><%= stats.shift %></p>
                </div>
                <div class="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center">
                    <i class="fas fa-clock text-purple-600 text-xl"></i>
                </div>
            </div>
        </div>
        <div class="stat-card p-6 rounded-2xl shadow-lg metric-card border-l-4 border-rose-500">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-semibold text-gray-600 uppercase tracking-wide">Cuti/Sakit Hari Ini</p>
                    <p class="text-3xl font-bold text-gray-800 mt-2"><%= stats.onLeave %></p>
                </div>
                <div class="w-12 h-12 bg-rose-100 rounded-full flex items-center justify-center">
                    <i class="fas fa-user-slash text-rose-600 text-xl"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Section -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
        <div class="chart-container p-6 rounded-2xl shadow-lg">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-semibold text-gray-800">Distribusi Tipe Personel</h3>
                <div class="flex items-center space-x-2">
                    <span class="w-3 h-3 bg-blue-500 rounded-full"></span>
                    <span class="text-sm text-gray-600">Aktif</span>
                </div>
            </div>
            <div class="relative h-64">
                <canvas id="tipePersonelChart"></canvas>
            </div>
        </div>
        <div class="chart-container p-6 rounded-2xl shadow-lg">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-semibold text-gray-800">Top 10 Posisi Kerja</h3>
                <div class="flex items-center space-x-2">
                    <i class="fas fa-chart-pie text-indigo-600"></i>
                    <span class="text-sm text-gray-600">Breakdown</span>
                </div>
            </div>
            <div class="relative h-64">
                <canvas id="posisiPieChart"></canvas>
            </div>
        </div>
            <div class="chart-container p-6 rounded-2xl shadow-lg">
        <div class="flex items-center justify-between mb-6">
            <h3 class="text-xl font-semibold text-gray-800">Posisi Paling Sering Kosong</h3>
                <div class="flex items-center space-x-2">
                    <i class="fas fa-exclamation-triangle text-orange-600"></i>
                    <span class="text-sm text-gray-600">Bulan Ini</span>
                </div>
            </div>
            <div class="relative h-64">
                <canvas id="posisiKosongChart"></canvas>
            </div>
           
    </div>

        <div class="chart-container p-6 rounded-2xl shadow-lg">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-semibold text-gray-800">Personel Terbanyak Dijadwalkan</h3>
                <div class="flex items-center space-x-2">
                    <i class="fas fa-star text-yellow-500"></i>
                    <span class="text-sm text-gray-600">Bulan Ini</span>
                </div>
            </div>
            <div class="relative h-64">
                <canvas id="personelSibukChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Full Width Chart -->
             <div class="chart-container p-6 rounded-2xl shadow-lg">
            <div class="flex items-center justify-between mb-6">
                 <h3 class="text-xl font-semibold text-gray-800">Distribusi Personel per Posisi</h3>
            <div class="flex items-center space-x-4">
                <div class="flex items-center space-x-2">
                    <span class="w-3 h-3 bg-teal-500 rounded-full"></span>
                    <span class="text-sm text-gray-600">Jumlah Personel</span>
                </div>
            </div>
        </div>
        <div class="relative h-80">
            <canvas id="posisiPersonelChart"></canvas>
        </div>
                
        </div>

</div>



<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
document.getElementById('exportExcelBtn').onclick = function() {
    // Data yang ingin diekspor (bisa Anda sesuaikan)
    const sheetData = [
        ['Statistik', 'Nilai'],
        ['Total Personel', <%= stats.personel %>],
        ['Total Posisi Kerja', <%= stats.posisi %>],
        ['Total Jenis Shift', <%= stats.shift %>],
        ['Cuti/Sakit Hari Ini', <%= stats.onLeave %>],
        [],
        ['Distribusi Personel per Posisi'],
        ['Posisi', 'Jumlah'],
        ...<%- JSON.stringify(chartData.posisiPersonel.map(d => [d.posisi_kerja_utama, d.jumlah])) %>
    ];

    // Buat worksheet dan workbook
    const ws = XLSX.utils.aoa_to_sheet(sheetData);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Dashboard");

    // Download file
    XLSX.writeFile(wb, "dashboard.xlsx");
};
</script>

<script>
    // Data dari server dengan fallback
    const tipeData = <%- JSON.stringify(chartData.tipePersonel || []) %>;
    const posisiData = <%- JSON.stringify(chartData.posisiPersonel || []) %>;
    const posisiKosongData = <%- JSON.stringify(chartData.posisiKosong || []) %>;
    const personelSibukData = <%- JSON.stringify(chartData.personelSibuk || []) %>;

    // Modern color palette
    const modernColors = {
        primary: ['#6366f1', '#8b5cf6', '#06b6d4', '#10b981', '#f59e0b', '#ef4444'],
        gradients: [
            'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
            'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
            'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
            'linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)',
            'linear-gradient(135deg, #fa709a 0%, #fee140 100%)',
            'linear-gradient(135deg, #a8edea 0%, #fed6e3 100%)'
        ]
    };

    // Plugin Chart.js untuk menampilkan pesan jika data kosong
    const noDataPlugin = {
        id: 'noData',
        afterDraw: (chart) => {
            if (
                !chart.data.datasets.length ||
                !chart.data.datasets[0].data.length ||
                chart.data.datasets[0].data.every(val => val === 0)
            ) {
                const { ctx, width, height } = chart;
                ctx.save();
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.font = '16px Inter, system-ui, sans-serif';
                ctx.fillStyle = '#cbd5e1';
                ctx.fillText('Tidak ada data', width / 2, height / 2);
                ctx.restore();
            }
        }
    };

    // Chart.js default configuration
    Chart.defaults.font.family = 'Inter, system-ui, sans-serif';
    Chart.defaults.font.size = 12;
    Chart.defaults.color = '#64748b';

    // Grafik 1: Distribusi Tipe Personel (Doughnut Chart)
    {
        const ctxTipe = document.getElementById('tipePersonelChart');
        new Chart(ctxTipe, {
            type: 'doughnut',
            data: {
                labels: tipeData.map(d => d.tipe_personel && d.tipe_personel.trim() ? d.tipe_personel : '(Tanpa Nama)'),
                datasets: [{
                    data: tipeData.map(d => d.jumlah),
                    backgroundColor: modernColors.primary.slice(0, tipeData.length),
                    borderWidth: 0,
                    cutout: '60%'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            usePointStyle: true,
                            padding: 20
                        }
                    },
                    noData: true
                }
            },
            plugins: [noDataPlugin]
        });
    }

    // Grafik 2: Perbandingan Personel per Posisi (Doughnut Chart)
    {
        const ctxPosisiPie = document.getElementById('posisiPieChart');
        new Chart(ctxPosisiPie, {
            type: 'doughnut',
            data: {
                labels: posisiData.map(d => d.posisi_kerja_utama),
                datasets: [{
                    data: posisiData.map(d => d.jumlah),
                    backgroundColor: modernColors.primary,
                    borderWidth: 0,
                    cutout: '60%'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            usePointStyle: true,
                            padding: 15
                        }
                    },
                    noData: true
                }
            },
            plugins: [noDataPlugin]
        });
    }

    // Grafik 3: Posisi Paling Sering Kosong (Horizontal Bar)
    {
        const ctxPosisiKosong = document.getElementById('posisiKosongChart');
        new Chart(ctxPosisiKosong, {
            type: 'bar',
            data: {
                labels: posisiKosongData.map(d => d.nama_posisi),
                datasets: [{
                    label: 'Slot Kosong',
                    data: posisiKosongData.map(d => d.jumlah),
                    backgroundColor: '#f59e0b',
                    borderRadius: 8,
                    borderSkipped: false
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                indexAxis: 'y',
                plugins: {
                    legend: { display: false },
                    noData: true
                },
                scales: {
                    x: {
                        beginAtZero: true,
                        grid: { display: false }
                    },
                    y: {
                        grid: { display: false }
                    }
                }
            },
            plugins: [noDataPlugin]
        });
    }

    // Grafik 4: Personel Paling Sibuk (Horizontal Bar)
    {
        const ctxPersonelSibuk = document.getElementById('personelSibukChart');
        new Chart(ctxPersonelSibuk, {
            type: 'bar',
            data: {
                labels: personelSibukData.map(d => d.nama_lengkap),
                datasets: [{
                    label: 'Jumlah Jadwal',
                    data: personelSibukData.map(d => d.jumlah),
                    backgroundColor: '#8b5cf6',
                    borderRadius: 8,
                    borderSkipped: false
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                indexAxis: 'y',
                plugins: {
                    legend: { display: false },
                    noData: true
                },
                scales: {
                    x: {
                        beginAtZero: true,
                        grid: { display: false }
                    },
                    y: {
                        grid: { display: false }
                    }
                }
            },
            plugins: [noDataPlugin]
        });
    }

    // Grafik 5: Jumlah Personel per Posisi (Horizontal Bar)
    {
        const ctxPosisiBar = document.getElementById('posisiPersonelChart');
        new Chart(ctxPosisiBar, {
            type: 'bar',
            data: {
                labels: posisiData.map(d => d.posisi_kerja_utama),
                datasets: [{
                    label: 'Jumlah Personel',
                    data: posisiData.map(d => d.jumlah),
                    backgroundColor: '#06b6d4',
                    borderRadius: 8,
                    borderSkipped: false
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                indexAxis: 'y',
                plugins: {
                    legend: { display: false },
                    noData: true
                },
                scales: {
                    x: {
                        beginAtZero: true,
                        grid: { 
                            display: true,
                            color: '#f1f5f9'
                        }
                    },
                    y: {
                        grid: { display: false }
                    }
                }
            },
            plugins: [noDataPlugin]
        });
    }
</script>

<%- include('partials/footer') %>
