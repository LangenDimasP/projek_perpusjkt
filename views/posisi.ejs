<%- include('partials/header') %>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

<div x-data="posisiController()" x-init="init()">
    <div x-show="showSuccessToast" x-transition x-cloak class="fixed top-24 right-8 z-50 bg-white border-l-4 border-green-500 rounded-lg shadow-2xl p-4 flex items-center">
        <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center mr-4"><i class="fas fa-check-circle text-green-500 text-xl"></i></div>
        <p class="text-gray-700 font-semibold" x-text="toastMessage"></p>
        <button @click="showSuccessToast = false" class="ml-4 text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
    </div>
    <div x-show="showErrorToast" x-transition x-cloak class="fixed top-24 right-8 z-50 bg-white border-l-4 border-red-500 rounded-lg shadow-2xl p-4 flex items-center">
        <div class="w-10 h-10 bg-red-100 rounded-full flex items-center justify-center mr-4"><i class="fas fa-exclamation-circle text-red-500 text-xl"></i></div>
        <p class="text-gray-700 font-semibold" x-text="toastMessage"></p>
        <button @click="showErrorToast = false" class="ml-4 text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
    </div>

    <div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
        <div class="relative w-full sm:w-1/2">
            <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
            <input @keyup.debounce.350ms="handleFilterChange()" type="text" name="search" id="search" class="w-full pl-12 pr-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 transition" value="<%= query.search || '' %>" placeholder="Cari nama posisi...">
        </div>
        <button @click="openAddModal()" class="w-full sm:w-auto bg-gradient-to-r from-blue-600 to-indigo-600 text-white font-semibold py-3 px-6 rounded-xl hover:from-blue-700 hover:to-indigo-700 transition-all transform hover:scale-105 whitespace-nowrap shadow-lg">
            <i class="fas fa-plus mr-2"></i>Tambah Posisi Baru
        </button>
    </div>

    <div id="table-content-container" @click="handlePaginationClick($event)">
        <div class="bg-white rounded-2xl shadow-lg border border-gray-100">
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-50"><tr><th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase">Nama Posisi</th><th class="px-6 py-4 text-center text-xs font-semibold text-gray-600 uppercase">Aksi</th></tr></thead>
                    <tbody id="posisiTableBody" class="divide-y divide-gray-100">
    <% if (posisi && posisi.length > 0) { %>
        <% posisi.forEach(p => { %>
            <tr class="hover:bg-gray-50 transition-colors">
                <td class="px-6 py-4">
                    <div class="flex items-center">
                        <div class="w-8 h-8 bg-indigo-100 rounded-full flex items-center justify-center mr-3 flex-shrink-0">
                            <i class="fas fa-briefcase text-indigo-600 text-sm"></i>
                        </div>
                        <span class="font-medium text-gray-900"><%= p.nama_posisi %></span>
                    </div>
                </td>
                <td class="px-6 py-4 text-center whitespace-nowrap">
                    <button @click="openEditModal(<%= p.id_posisi %>)" class="inline-flex items-center px-3 py-1 rounded-lg text-sm font-medium text-indigo-600 hover:text-indigo-800 hover:bg-indigo-50 transition-colors">
                        <i class="fas fa-edit mr-1"></i>Edit
                    </button>
                    <span class="text-gray-300 mx-1">|</span>
                    <form :id="'delete-form-' + <%= p.id_posisi %>" action="/posisi/hapus/<%= p.id_posisi %>" method="POST" class="inline-block"></form>
                    <button type="button" @click="confirmDelete(<%= p.id_posisi %>, '<%= p.nama_posisi %>')" class="inline-flex items-center px-3 py-1 rounded-lg text-sm font-medium text-red-600 hover:text-red-800 hover:bg-red-50 transition-colors">
                        <i class="fas fa-trash mr-1"></i>Hapus
                    </button>
                </td>
            </tr>
        <% }) %>
    <% } else { %>
        <tr>
            <td colspan="2" class="text-center py-12">
                <div class="flex flex-col items-center">
                    <i class="fas fa-briefcase text-gray-400 text-4xl mb-4"></i>
                    <p class="text-gray-500 text-lg">Posisi tidak ditemukan.</p>
                </div>
            </td>
        </tr>
    <% } %>
</tbody>
                </table>
            </div>
            <div class="p-4 flex justify-center" id="paginationContainer">
                <% if (totalPages > 1) { %><nav class="inline-flex rounded-md shadow-sm -space-x-px"><% const params = new URLSearchParams(query); %><% if (currentPage > 1) { %><% params.set('page', currentPage - 1); %><a href="/posisi?<%= params.toString() %>" class="pagination-link relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">&laquo;</a><% } %><% for(let i = 1; i <= totalPages; i++) { %><% params.set('page', i); %><% if (i === currentPage) { %><span class="pagination-link relative z-10 inline-flex items-center px-4 py-2 border border-blue-500 bg-blue-50 text-sm font-medium text-blue-600"><%= i %></span><% } else { %><a href="/posisi?<%= params.toString() %>" class="pagination-link relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50"><%= i %></a><% } %><% } %><% if (currentPage < totalPages) { %><% params.set('page', currentPage + 1); %><a href="/posisi?<%= params.toString() %>" class="pagination-link relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">&raquo;</a><% } %></nav><% } %>
            </div>
        </div>
    </div>

    <div x-show="showModal" @keydown.escape.window="showModal = false" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-50" style="display: none;">
        <div @click.away="showModal = false" class="w-full max-w-md bg-white rounded-2xl shadow-xl">
            <div class="flex justify-between items-center p-6 border-b border-gray-100"><h2 class="text-xl font-semibold text-gray-800" x-text="isEditing ? 'Edit Posisi' : 'Tambah Posisi Baru'"></h2><button @click="showModal = false" class="text-gray-400 hover:text-gray-600 text-2xl">Ã—</button></div>
            <template x-if="showModal">
                <form @submit.prevent="isEditing ? submitEditForm() : submitAddForm()" class="p-6 space-y-4">
                    <input type="hidden" x-model="formData.id_posisi">
                    <div><label for="modal_nama_posisi" class="block text-sm font-semibold text-gray-700 mb-2">Nama Posisi</label><input type="text" x-model="formData.nama_posisi" id="modal_nama_posisi" name="nama_posisi" class="w-full px-4 py-3 border border-gray-200 rounded-xl" required></div>
                    <button type="submit" class="w-full bg-gradient-to-r from-blue-600 to-indigo-600 text-white font-semibold py-3 px-6 rounded-xl hover:from-blue-700 hover:to-indigo-700"><i class="fas fa-save mr-2"></i><span x-text="isEditing ? 'Simpan Perubahan' : 'Tambah Posisi'"></span></button>
                </form>
            </template>
        </div>
    </div>

    <div x-show="showDeleteConfirmModal" @keydown.escape.window="showDeleteConfirmModal = false" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-50" style="display: none;">
        <div @click.away="showDeleteConfirmModal = false" class="w-full max-w-md bg-white rounded-2xl shadow-xl">
            <div class="p-8 text-center">
                <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-5"><i class="fas fa-exclamation-triangle text-red-500 text-3xl"></i></div>
                <h2 class="text-2xl font-bold text-gray-800">Konfirmasi Hapus</h2>
                <p class="text-gray-600 mt-2">Anda yakin ingin menghapus posisi <br> "<strong x-text="itemToDelete.name"></strong>"?<br><span class="font-semibold text-red-600">Aksi ini tidak dapat dibatalkan.</span></p>
                <div class="mt-6 flex justify-center gap-4">
                    <button @click="showDeleteConfirmModal = false" class="px-8 py-2.5 bg-gray-200 text-gray-800 font-semibold rounded-lg hover:bg-gray-300">Batal</button>
                    <button @click="executeDelete()" class="px-8 py-2.5 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700">Ya, Hapus</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('alpine:init', () => {
    Alpine.data('posisiController', () => ({
        showModal: false,
        isEditing: false,
        formData: { id_posisi: null, nama_posisi: '' },
        showSuccessToast: false,
        showErrorToast: false,
        toastMessage: '',
        showDeleteConfirmModal: false,
        itemToDelete: { id: null, name: '' },
        debounceTimer: null,
        
        init() {
            const params = new URLSearchParams(window.location.search);
            const status = params.get('status');
            if (status === 'hapus_sukses') { this.triggerToast('Posisi berhasil dihapus.', 'success'); }
            else if (status === 'gagal') { this.triggerToast('Aksi gagal, terjadi kesalahan di server.', 'error'); }
            if (status) { window.history.replaceState({}, document.title, '/posisi'); }
        },
        triggerToast(message, type = 'success') {
            this.toastMessage = message;
            if (type === 'success') { this.showSuccessToast = true; setTimeout(() => this.showSuccessToast = false, 3000); } 
            else { this.showErrorToast = true; setTimeout(() => this.showErrorToast = false, 4000); }
        },
        openAddModal() { this.isEditing = false; this.formData = { id_posisi: null, nama_posisi: '' }; this.showModal = true; },
        openEditModal(id) { fetch(`/api/posisi/${id}`).then(r => r.json()).then(data => { this.isEditing = true; this.formData = data; this.showModal = true; }); },
        
        submitAddForm() {
            fetch('/posisi/tambah', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ nama_posisi: this.formData.nama_posisi })
            }).then(async res => {
                const data = await res.json();
                if (!res.ok) throw new Error(data.message || `Error ${res.status}`);
                return data;
            }).then(data => {
                this.showModal = false; this.triggerToast(data.message, 'success'); this.handleFilterChange();
            }).catch(error => {
                this.showModal = false; this.triggerToast(error.message, 'error');
            });
        },
        submitEditForm() {
            fetch(`/api/posisi/update/${this.formData.id_posisi}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ nama_posisi: this.formData.nama_posisi })
            }).then(r => r.json()).then(data => {
                if (data.success) { this.showModal = false; this.triggerToast(data.message, 'success'); this.handleFilterChange(); } 
                else { this.triggerToast(data.message || 'Gagal memperbarui posisi.', 'error'); }
            });
        },
        confirmDelete(id, name) { this.itemToDelete = { id, name }; this.showDeleteConfirmModal = true; },
        executeDelete() {
            this.showDeleteConfirmModal = false;
            fetch(`/posisi/hapus/${this.itemToDelete.id}`, {
                method: 'POST',
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            })
            .then(async res => {
                let data;
                try { data = await res.json(); } catch { data = {}; }
                if (!res.ok) throw new Error(data.message || `Error ${res.status}`);
                return data;
            })
            .then(data => {
                this.triggerToast(data.message, 'success');
                this.handleFilterChange();
            })
            .catch(error => {
                this.triggerToast(error.message, 'error');
            });
        },
        handleFilterChange() {
            const searchInput = document.querySelector('#search');
            const params = new URLSearchParams({ search: searchInput ? searchInput.value : '', page: 1 });
            const url = `/posisi?${params.toString()}`;
            window.history.pushState({ path: url }, '', url);
            this.fetchAndUpdateTable(url);
        },
        debounceHandleFilter() { clearTimeout(this.debounceTimer); this.debounceTimer = setTimeout(() => this.handleFilterChange(), 350); },
        async fetchAndUpdateTable(url) {
            const container = document.getElementById('table-content-container');
            try {
                container.style.opacity = '0.5';
                const response = await fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
                const newHtml = await response.text();
                const parser = new DOMParser();
                const newDoc = parser.parseFromString(newHtml, 'text/html');
                container.innerHTML = newDoc.getElementById('table-content-container').innerHTML;
            } catch (error) { console.error('Error:', error); }
            finally { container.style.opacity = '1'; }
        },
        handlePaginationClick(event) {
            const link = event.target.closest('a.pagination-link');
            if (link) { event.preventDefault(); const url = link.href; window.history.pushState({ path: url }, '', url); this.fetchAndUpdateTable(url); }
        }
    }));
});
</script>

<%- include('partials/footer') %>